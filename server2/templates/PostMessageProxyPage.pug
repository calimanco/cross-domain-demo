extends layout.pug

block head
  title PostMessage Proxy Page

block content
  p This is a proxy page for PostMessage, which is generated by server2.
  p#count

block scripts
  script(src='http://demo.com/xhr.js')
  script.
    const targetOrigin = "http://demo.com";
    const countElem = document.getElementById("count");
    let count = 0;
    window.addEventListener("message", event => {
      if (event.origin !== targetOrigin) {
        return;
      }
      const { msgId, method, url, data } = event.data;
      xhr({
        method,
        url,
        data,
      }).then(res => {
        res.data.msgId = msgId;
        event.source.postMessage(res, targetOrigin);
        count += 1;
        countElem.innerText = `Number of requests: ${count}`;
      });
    });
